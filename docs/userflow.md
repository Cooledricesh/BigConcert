# 콘서트 예약 시스템 - 기능 단위 유저플로우

## 개요
본 문서는 콘서트 예약 시스템의 주요 기능별 유저플로우를 정의합니다.
각 플로우는 입력, 처리, 출력 단계로 구성되며, 발생 가능한 엣지케이스를 포함합니다.

---

## 유저플로우 1: 콘서트 목록 조회

### 1. 입력
- 사용자가 홈페이지 접속
- 스크롤 동작으로 추가 콘서트 목록 요청 (무한 스크롤 적용)
- 콘서트 카드/항목 클릭

### 2. 처리
**단계 1: 초기 로딩**
- 시스템이 콘서트 데이터베이스 조회
- 공연 날짜 기준으로 정렬 (과거 공연 필터링)
- 각 콘서트별 잔여 좌석 수 집계

**단계 2: 데이터 변환**
- 콘서트 정보를 표시 형태로 변환
- 썸네일 이미지 URL 유효성 검증
- 날짜/시간 포맷팅

**단계 3: 상호작용 처리**
- 클릭 이벤트 발생 시 해당 콘서트 ID 식별
- 라우팅 준비

### 3. 출력
**성공 케이스:**
- 콘서트 목록 카드 형태로 렌더링
- 각 카드에 썸네일, 제목, 아티스트, 날짜, 장소 표시
- 클릭 시 상세 페이지로 이동

**엣지 케이스:**
- 콘서트 목록이 비어있을 경우: 안내 메시지 표시
- 이미지 로딩 실패 시: 대체 이미지 표시
- 네트워크 오류 시: 에러 메시지 및 재시도 버튼 표시
- 데이터 로딩 중: 스켈레톤 UI 또는 로딩 인디케이터 표시

---

## 유저플로우 2: 콘서트 상세 정보 조회

### 1. 입력
- 콘서트 목록에서 특정 콘서트 선택
- URL 직접 입력 또는 북마크 접근
- 예약하기 버튼 클릭
- 브라우저 뒤로가기/새로고침

### 2. 처리
**단계 1: 데이터 검증**
- URL 파라미터에서 콘서트 ID 추출
- 유효한 UUID 형식 검증
- 콘서트 존재 여부 확인

**단계 2: 상세 정보 조회**
- 콘서트 기본 정보 조회 (제목, 아티스트, 날짜, 장소, 설명)
- 좌석 테이블에서 등급별 집계 쿼리 실행
  - 각 등급(Special, Premium, Advanced, Regular)별 전체 좌석 수
  - 각 등급별 예약 가능 좌석 수
  - 등급별 가격 정보

**단계 3: 데이터 가공**
- 날짜/시간 사용자 친화적 형식으로 변환
- 잔여 좌석 비율 계산 (백분율)
- 매진 여부 판단

### 3. 출력
**성공 케이스:**
- 콘서트 포스터 이미지 표시
- 공연 상세 정보 렌더링
- 등급별 잔여 좌석 현황 시각화 (바 그래프)
- 등급별 가격표 표시
- 예약 가능 시 예약하기 버튼 활성화

**엣지 케이스:**
- 존재하지 않는 콘서트 ID: 404 페이지 또는 목록으로 리다이렉트
- 이미지 로딩 실패: 기본 이미지 표시
- 공연 날짜 지남: 예약 불가 안내 및 버튼 비활성화
- 전체 매진: 매진 안내 메시지 및 버튼 비활성화
- 데이터 로딩 중: 스켈레톤 UI 표시
- 네트워크 오류: 에러 메시지 및 재시도 옵션

---

## 유저플로우 3: 좌석 선택

### 1. 입력
- 콘서트 상세 페이지에서 예약하기 버튼 클릭
- 좌석 배치도에서 개별 좌석 클릭/탭
- 선택된 좌석 해제 (재클릭)
- 좌석 선택 후 예약하기 버튼 클릭
- 브라우저 뒤로가기

### 2. 처리
**단계 1: 좌석 데이터 로드**
- 해당 콘서트의 전체 좌석 정보 조회
- 구역(A,B,C,D), 열(1-20), 좌석번호(1-4) 구조로 배치
  - 각 구역당 4개 좌석 × 20열 = 80좌석
  - 전체 좌석: 4구역 × 80좌석 = 320좌석
- 각 좌석의 상태(available/reserved) 확인
- 등급별 가격 정보 매핑
  - Special (1-3열): 250,000원
  - Premium (4-7열): 190,000원
  - Advanced (8-15열): 170,000원
  - Regular (16-20열): 140,000원

**단계 2: 좌석 선택 로직**
- 클릭한 좌석의 현재 상태 확인
- 선택 가능 여부 검증 (reserved가 아닌 경우만)
- 현재 선택 좌석 수 확인 (최대 4매 제한)
- 로컬 상태에 선택 좌석 추가/제거
- 선택 좌석 총 금액 실시간 계산
  - 각 좌석의 등급별 가격 × 선택 좌석 수
  - 예: Special 2매 + Premium 2매 = (250,000 × 2) + (190,000 × 2) = 880,000원

**단계 3: 선택 유효성 검증**
- 최소 1개 이상 좌석 선택 여부
- 최대 4매 선택 제한 확인
- 선택한 좌석의 최신 예약 상태 재확인

### 3. 출력
**성공 케이스:**
- 좌석 배치도 시각적 렌더링 (구역/열/번호 표시)
  - 4개 구역(A,B,C,D) × 20열 × 4좌석 = 총 320좌석
  - 구역-열-번호 형식 표시 (예: A-1-3)
- 좌석 상태별 색상 구분 표시
  - 등급별 색상 (선택 가능)
  - 선택됨 (강조 표시)
  - 예약 완료 (비활성화)
- 선택 좌석 정보 실시간 업데이트
  - 선택한 좌석 목록 (최대 4매)
  - 각 좌석의 등급 및 가격
- 총 금액 표시
- 예약하기 버튼 활성화 (좌석 선택 시)

**엣지 케이스:**
- 모든 좌석 매진: 매진 안내 메시지
- 다른 사용자가 동시 선택: 선택 불가 알림
- 네트워크 오류: 좌석 정보 로드 실패 메시지
- 좌석 미선택 상태로 예약 시도: 좌석 선택 요청 메시지
- 세션 타임아웃: 재선택 요청 또는 처음부터 다시 진행
- 최대 4매 초과 선택 시도: "최대 4매까지 선택 가능합니다" 안내 메시지

---

## 유저플로우 4: 예약 정보 입력 및 예약 완료

### 1. 입력
- 좌석 선택 페이지에서 예약하기 버튼 클릭
- 예약자명 입력
- 전화번호 입력
- 비밀번호 4자리 입력
- 예약 완료 버튼 클릭
- 브라우저 뒤로가기

### 2. 처리
**단계 1: 선택 정보 검증**
- 세션/상태에서 선택 좌석 정보 확인
- 선택 좌석 유효성 재검증
- 좌석 실시간 가용성 확인 (다른 사용자 선점 여부)

**단계 2: 입력 데이터 검증**
- 예약자명: 공백 제거, 길이 제한 확인
- 전화번호: 형식 검증, 숫자만 추출
- 비밀번호: 4자리 숫자 검증
- 중복 예약 검증: 동일 전화번호로 같은 콘서트 기예약 여부 확인

**단계 3: 예약 트랜잭션 처리**
- 데이터베이스 트랜잭션 시작
- 선택 좌석 상태 재확인 (동시성 제어)
- bookings 테이블에 예약 정보 삽입
- booking_seats 테이블에 좌석 매핑 정보 삽입
- seats 테이블의 좌석 상태 업데이트 (reserved로 변경)
- 비밀번호 해시 처리 후 저장
- 트랜잭션 커밋 또는 롤백

### 3. 출력
**성공 케이스:**
- 예약 정보 요약 표시
- 총 금액 확인
- 입력 필드 유효성 실시간 피드백
- 예약 완료 시 확인 페이지로 이동
- 예약 번호/ID 생성 및 표시

**엣지 케이스:**
- 선택 좌석 세션 만료: 좌석 선택 페이지로 리다이렉트
- 좌석 이미 예약됨: 다른 좌석 선택 유도, 선택 페이지로 복귀
- 중복 예약 감지: "이미 해당 공연을 예약하셨습니다" 안내 메시지
- 필수 입력 누락: 해당 필드 에러 메시지 표시
- 잘못된 형식 입력: 형식 안내 메시지
- 네트워크 오류: 재시도 옵션 제공
- 트랜잭션 실패: 롤백 후 에러 메시지, 재시도 유도
- 중복 제출 방지: 버튼 비활성화, 로딩 상태 표시

---

## 유저플로우 5: 예약 조회

### 1. 입력
- 헤더의 예약 조회 링크 클릭
- 전화번호 입력
- 비밀번호 4자리 입력
- 조회 버튼 클릭
- 브라우저 새로고침

### 2. 처리
**단계 1: 입력 검증**
- 전화번호 형식 검증 (숫자만 추출)
- 비밀번호 4자리 숫자 검증
- 필수 입력 필드 확인

**단계 2: 예약 정보 조회**
- 전화번호로 예약 레코드 검색
- 비밀번호 해시값 비교 검증
- 일치하는 예약 정보 추출
- 관련 콘서트 정보 JOIN 조회
- 예약된 좌석 상세 정보 조회

**단계 3: 데이터 가공**
- 예약 정보 정렬 (최신순 또는 공연일 기준)
- 공연일 기준 예약 상태 판단 (예정/종료)
- 좌석 정보 포맷팅 (예: A-1-3, B-5-2)

### 3. 출력
**성공 케이스:**
- 예약 목록 표시 (복수 예약 가능)
- 각 예약별 상세 정보 표시
  - 콘서트 정보 (제목, 날짜, 장소)
  - 좌석 정보 (구역-열-번호, 등급)
  - 예약자명
  - 총 금액
  - 예약 일시

**엣지 케이스:**
- 일치하는 예약 없음: 예약 정보 없음 메시지
- 비밀번호 불일치: 인증 실패 메시지, 재입력 유도
- 필수 정보 미입력: 입력 요청 메시지
- 잘못된 전화번호 형식: 형식 안내 메시지
- 다수 예약 존재: 전체 목록 표시
- 네트워크 오류: 에러 메시지 및 재시도 버튼
- 연속 실패 시도: 일시적 접근 제한 (브루트포스 방지)

---

## 유저플로우 6: 예약 완료 후 행동

### 1. 입력
- 예약 완료 페이지 도달
- "예약 조회" 버튼 클릭
- "홈으로" 버튼 클릭
- 브라우저 뒤로가기
- URL 북마크 또는 직접 접근

### 2. 처리
**단계 1: 예약 완료 상태 확인**
- 세션/상태에서 방금 완료된 예약 정보 확인
- 예약 ID 유효성 검증
- 예약 상세 정보 조회

**단계 2: 페이지 이동 처리**
- 예약 조회 선택 시: 전화번호 자동 입력 준비
- 홈으로 선택 시: 세션 정리
- 뒤로가기 방지: 이미 처리된 예약 중복 방지

**단계 3: 세션 관리**
- 임시 저장된 선택 좌석 정보 삭제
- 예약 프로세스 상태 초기화
- 필요시 예약 정보 로컬 저장 (조회 편의)

### 3. 출력
**성공 케이스:**
- 예약 완료 확인 메시지
- 예약 상세 정보 명확히 표시
- 예약 조회 페이지 이동 (전화번호 자동 입력)
- 홈 페이지로 깔끔한 이동

**엣지 케이스:**
- 직접 URL 접근: 예약 정보 없으면 홈으로 리다이렉트
- 뒤로가기 시도: 경고 메시지 또는 홈으로 이동
- 새로고침: 예약 정보 유지하여 재표시
- 세션 만료: 예약은 완료되었음을 안내
- 네트워크 오류: 예약 완료 상태는 유지, 조회 안내

---

## 플로우 다이어그램

### 메인 예약 플로우
```
홈(목록) → 콘서트 상세 → 좌석 선택 → 예약 정보 입력 → 예약 완료
                                                            ↓
                                                        예약 조회
```

### 예약 조회 플로우
```
헤더 예약 조회 링크 → 인증 정보 입력 → 예약 목록 조회 → 상세 정보 확인
```

---

## 주요 고려사항

### 동시성 처리
- 좌석 선택 시 실시간 가용성 확인
- 예약 트랜잭션 시 좌석 상태 재확인
- 낙관적 업데이트와 롤백 처리

### 세션 관리
- 예약 프로세스 중 선택 정보 유지
- 완료 후 세션 정리

### 보안
- 비밀번호 해시 처리
- 브루트포스 공격 방지
- 입력 데이터 검증

### 사용자 경험
- 명확한 에러 메시지
- 진행 상황 표시
- 뒤로가기 처리
- 로딩 상태 표시
- 최대 4매 선택 제한 사전 안내

---

## 버전 정보
- 작성일: 2025-10-15
- 수정일: 2025-10-15
- 버전: 1.1.0
- 기반 문서: PRD v1.0
- 주요 변경사항: 좌석 배치 구조 명확화, 가격 정책 상세 추가, 최대 선택 4매 제한, 중복 예약 방지 로직 추가